<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https://whitehouse-actions-tracker.onrender.com;
                   script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com;
                   style-src 'self' 'unsafe-inline';
                   img-src 'self' data: https://www.whitehouse.gov;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>White House Presidential Actions Tracker</title>
    <link rel="stylesheet" href="style.css">
    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "YOUR_TOKEN"}'></script>
    <!-- End Cloudflare Web Analytics -->
</head>
<body>
    <header>
        <h1>White House Presidential Actions Tracker</h1>
        <p>Latest executive orders, memoranda, and proclamations</p>
    </header>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search actions...">
    </div>

    <div class="container">
        <div id="loading" class="loader"></div>
        <div id="actions-container"></div>
        <div id="error-message" class="error-message"></div>
    </div>

    <div class="refresh-button" onclick="refreshData()">⟳ Refresh Data</div>

    <footer>
        <p>&copy; 2023 White House Action Tracker. Official documents from <a href="https://www.whitehouse.gov/presidential-actions/" target="_blank" rel="noopener noreferrer" style="color: white;">whitehouse.gov</a></p>
    </footer>

    <script>
        // Configuration
        const CACHE_TTL = 3600000; // 1 hour
        const MAX_RETRIES = 3;
        let retryCount = 0;
        const PROXY_URL = 'https://whitehouse-actions-tracker.onrender.com/proxy?url=';
        const WH_FEED = 'https://www.whitehouse.gov/feed/';

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            checkCache();
            setupSearch();
        });

        function checkCache() {
            const cachedData = localStorage.getItem('whActionsCache');
            const cacheTime = localStorage.getItem('whActionsCacheTime');
            
            if (cachedData && cacheTime && Date.now() - cacheTime < CACHE_TTL) {
                renderActions(JSON.parse(cachedData));
                document.getElementById('loading').style.display = 'none';
            } else {
                fetchPresidentialActions();
            }
        }

        async function fetchPresidentialActions() {
            try {
                const response = await fetch(`${PROXY_URL}${encodeURIComponent(WH_FEED)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data.contents, "text/xml");
                processData(xmlDoc);
                retryCount = 0;
            } catch (error) {
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return fetchPresidentialActions();
                }
                showError(`Failed to load presidential actions. Please try again later. (${error.message})`);
            }
        }

        function processData(xmlDoc) {
            const items = xmlDoc.getElementsByTagName('item');
            const actions = [];
            
            Array.from(items).forEach(item => {
                const categories = Array.from(item.getElementsByTagName('category'))
                                    .map(cat => cat.textContent);
                
                if (categories.includes('Presidential Actions')) {
                    actions.push({
                        title: sanitizeHTML(item.getElementsByTagName('title')[0].textContent),
                        link: item.getElementsByTagName('link')[0].textContent,
                        pubDate: item.getElementsByTagName('pubDate')[0].textContent,
                        description: sanitizeHTML(item.getElementsByTagName('description')[0].textContent)
                    });
                }
            });

            localStorage.setItem('whActionsCache', JSON.stringify(actions));
            localStorage.setItem('whActionsCacheTime', Date.now());
            renderActions(actions);
            document.getElementById('loading').style.display = 'none';
        }

        function renderActions(actions) {
            const actionsContainer = document.getElementById('actions-container');
            actionsContainer.innerHTML = '';
            
            actions.forEach(item => {
                const pubDate = new Date(item.pubDate);
                const actionCard = document.createElement('article');
                actionCard.className = 'action-card';
                actionCard.innerHTML = `
                    <p class="action-date">${pubDate.toLocaleDateString('en-US', { dateStyle: 'long' })}</p>
                    <h2 class="action-title">${item.title}</h2>
                    <div class="action-summary">
                        <p>${item.description}</p>
                    </div>
                    <a href="${item.link}" class="full-document-link" target="_blank" rel="noopener noreferrer">
                        Read Full Document
                    </a>
                `;
                actionsContainer.appendChild(actionCard);
            });

            if (actions.length === 0) {
                showError('No recent presidential actions found.');
            }
        }

        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = `
                <div class="error-alert">
                    ⚠️ ${message}
                    <div class="retry-button" onclick="refreshData()">
                        Retry Now
                    </div>
                </div>
            `;
            document.getElementById('loading').style.display = 'none';
        }

        function refreshData() {
            localStorage.removeItem('whActionsCache');
            localStorage.removeItem('whActionsCacheTime');
            document.getElementById('actions-container').innerHTML = '';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-message').textContent = '';
            retryCount = 0;
            fetchPresidentialActions();
        }

        function setupSearch() {
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const cards = document.querySelectorAll('.action-card');
                
                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
        }
    </script>
</body>
</html>